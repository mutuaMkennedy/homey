{% extends 'base1.html' %}
{% load static %}
{% load cloudinary %}
{% block content %}

<script src="{% static 'js/jquery.min.js' %}"></script>
      <script type="text/javascript">

        $(document).ready(function(event){
          // save
          $(document).on('click','#proSave', function(event){
             event.preventDefault();
             var pk = $(this).attr('value');
             $.ajax({
               type : 'post',
               url : '{% url "profiles:save_pm"%}',
               data : {
                  'pk':pk,
                  'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val()
               },
               dataType: 'json',
               // success
               success: function(response) {
                 $('#_savePro').html(response['form'])


               },
               error: function(rs,e){
               },
             });
          });
          //follow
          $(document).on('click','#proFollow', function(event){
             event.preventDefault();
             var pk = $(this).attr('value');
             $.ajax({
               type : 'post',
               url : '{% url "profiles:follow_pm"%}',
               data : {
                  'pk':pk,
                  'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val()
               },
               dataType: 'json',
               // success
               success: function(response) {
                 $('#_followPro').html(response['form'])


               },
               error: function(rs,e){
               },
             });
          });
          //join team
          $(document).on('click','#_proTeam', function(event){
             event.preventDefault();
             var user = $(this).attr('value');
             $.ajax({
               type : 'post',
               url : '{% url "profiles:request_connection"%}',
               data : {
                  'user':user,
                  'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val()
               },
               dataType: 'json',
               // success
               success: function(response) {
                 $('#_join_leave_team').html(response['form'])


               },
               error: function(rs,e){
               },
             });
          });
          $(".owl-carousel").owlCarousel({
              // loop:true,
              margin:10,
              nav:true,
              responsiveClass:true,
              responsive:{
                 0:{
                     items:2,
                     nav:true
                 },
                 480:{
                     items:2,
                     nav:true
                 },
                 768:{
                     items:2,
                     nav:true,
                 }
             }
            });
        });
</script>

<div class="ag-dtl-wrapper">
  <div class="bs-pfl-swc-wrp">
    <ul id="bs-pfl-switch" class="tabs">
        <li class="tab col s3"><a href="#pm-about-vw">Posts</a></li>
        <li class="tab col s3"><a href="#pm-sr-lsts-vw">Listings</a></li>
        <li class="tab col s3"><a href="#pm-Portfolio-vw">Portfolio</a></li>
    </ul>
    {% if user_1 == user_2 %} <button type="button" name="button">This is your business page</button>{%endif %}
  </div>
<section>
  <div class="container" style="width:95%">
    <div class="row">
      <div class="_pfPgWrapper col s12" style="padding:0;">
        <div class="ag-d-left-content">
          <div id="ag-d-card" class="card">
              <div class="card-header">
                  <div class="bsPCoverOverlay">
                    <div class="img-rv-wrapper">
                      <div class="ag-d-img">
                        {% if agent.user.profile_image%}
                        <img src="{{agent.user.profile_image.url}}" alt="{{agent.user.first_name}}" style="width:150px;height:150px;object-fit:cover;">
                        {% else %}
                        <img src="{%static 'img/avatar.png'%}" alt="{{agent.user.first_name}}" style="width:150px;height:150px;object-fit:cover;">
                        {% endif %}
                      </div>
                      <div class="ag-d-details">
                        <div class="ag-rLr-box">
                            <div class="agNm-Ratings">
                                <div class="b-dtls-wrp">
                                  <div class="b-dtls">
                                    <h5> {{agent.user.get_full_name}}</h5>
                                  </div>
                                  <div class="ag-rating">
                                    {% if average_rating.rating__avg %}
                                        {% if average_rating.rating__avg  > 4.5  and average_rating.rating__avg <= 5 %}
                                        <li> <span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span></li>
                                        {%elif average_rating.rating__avg > 3.5 and average_rating.rating__avg <= 4.5 %}
                                        <li> <span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span></li>
                                        {% elif average_rating.rating__avg > 2.5 and average_rating.rating__avg <= 3.5 %}
                                        <li> <span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                                        {% elif average_rating.rating__avg > 1.5 and average_rating.rating__avg <= 2.5 %}
                                        <li> <span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                                        {% elif average_rating.rating__avg > 0 and average_rating.rating__avg <= 1.5 %}
                                        <li> <span class="material-icons">star_rate</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                                        {% else %}
                                        <li> <span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                                        {% endif %}
                                    {% else %}
                                    <li> <span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                                    {% endif %}
                                  </div>
                                  <h6><span class="material-icons">location_on</span> {{agent.address}}</h6>
                                </div>
                            </div>
                            <div class="bPg-CTA-btns">
                              <div id="_savePro">
                                  {% include 'profiles/save-pm-section.html'%}
                              </div>
                              <div class="ag-messageBtn">
                                <a href="#_contactProModal" class="modal-trigger">
                                  <button type="button" name="button">
                                    <span class="material-icons" >message</span>
                                  </button>
                                </a>
                              </div>
                              <div class="bp-report">
                                <a href="#problemReport" class="modal-trigger">
                                  <button type="button" name="button">
                                    <span class="material-icons">flag</span>
                                  </button>
                                </a>
                              </div>
                            </div>
                        </div>
                      </div>
                    </div>
                  </div>
              </div>
              <div class="_actionToolBar">
                  <div class="_aCTA-btns">
                    <div class="g-lst-svf-box">
                        <div class="ag-d-lst">
                          <a href="#">
                            <span>{{agent.saves.count}}</span>
                            <h6>Saves</h6>
                          </a>
                          <a href="#">
                            <span>{{agent.followers.count}}</span>
                            <h6>Followers</h6>
                          </a>
                          <a href="#">
                            <span>{{pro_teammates.count}}</span>
                            <h6>Connections</h6>
                          </a>
                        </div>
                        <div class="ag-SvFo">
                          <div id="_followPro">
                              {% include 'profiles/follow-pm-section.html'%}
                          </div>
                          {% if request.user.user_type != 'NormalUser'%}
                          <div id="_join_leave_team">
                            {% include 'profiles/add-to-team.html'%}
                          </div>
                          {% endif %}
                        </div>
                    </div>
                  </div>
              </div>
          </div>
          <div class="proffesional-dtls card">
            <div id="ag-o-d">
              <li><span class="material-icons">call</span>{{agent.phone}}</li>
              {% if agent.website_link%}
              <li><span class="material-icons">public</span><a href="#" target='_blank'>{{agent.website_link}}</a></li>
              {% endif %}
              <ul>
                <li><b>License No:</b><br> {{agent.license_number}}</li>
                <li><b>Rehgien Member since:</b><br> {{agent.member_since.date}}</li>
                <li class="social-btns"><b>Follow Us:</b><br>
                  {% if agent.linkedin_link%}
                  <a href="{{agent.linkedin_link}}" target='_blank'><i class="fab fa-linkedin-in fa-2x"></i></a>
                  {% endif %}
                  {% if agent.facebook_link%}
                  <a href="{{agent.facebook_link}}" target='_blank'><i class="fab fa-facebook-f fa-2x"></i></a>
                  {% endif%}
                  {% if agent.twitter_link%}
                  <a href="{{agent.twitter_link}}" target='_blank'><i class="fab fa-twitter fa-2x"></i></a>
                  {% endif%}
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="ag-d-second-content">
              <div class="Pr-about-vw" id='pm-about-vw'>
                  <div class="ag_featuredListings">
                    <div class="_pf_sectionHeader">
                      <h1>Featured listings</h1>
                    </div>
                    <div class="{% if agent%}owl-carousel{% endif %} ag_featuredCarousel">
                        {% if agent%}
                          <div class="_pf_FeaturedItem card">

                              <div class="_pf_FeaturedItemImg">
                                <img src="{%static 'img/place1.jpg'%}">
                              </div>
                              <div class="_pf_FeaturedCtOvy">
                                <div class="_pf_FeaturedItemDt">
                                  <h5>Bream View townhouse</h5>
                                  <h3>Ksh: 25,000,000</h3>
                                  <h4>3ba 5bd 120sqm <span>Muthaiga, Nairobi, Kenya</span></h4>
                                </div>
                            </div>
                          </div>
                          <div class="_pf_FeaturedItem card">
                              <div class="_pf_FeaturedItemImg">
                                <img src="{%static 'img/place2.jpg'%}">
                              </div>
                              <div class="_pf_FeaturedCtOvy">
                                <div class="_pf_FeaturedItemDt">
                                  <h5>Bream View townhouse</h5>
                                  <h3>Ksh: 25,000,000</h3>
                                  <h4>3ba 5bd 120sqm <span>Muthaiga, Nairobi, Kenya</span></h4>
                                </div>
                            </div>
                          </div>
                          <div class="_pf_FeaturedItem card">
                              <div class="_pf_FeaturedItemImg">
                                <img src="{%static 'img/place3.jpg'%}">
                              </div>
                              <div class="_pf_FeaturedCtOvy">
                                <div class="_pf_FeaturedItemDt">
                                  <h5>Bream View townhouse</h5>
                                  <h3>Ksh: 25,000,000</h3>
                                  <h4>3ba 5bd 120sqm <span>Muthaiga, Nairobi, Kenya</span></h4>
                                </div>
                            </div>
                          </div>
                        {%else%}
                            <div class="pflpages-no-results">
                              <img src="{%static 'img/note.svg'%}" alt="empty">
                              <p>Nothing yet. <br> Featured listings will appear here</p>
                            </div>
                        {%endif%}
                    </div>
                  </div>
                  <div class="ag-about ">
                      <div class="_pf_sectionHeader">
                        <h1>Who we are</h1>
                      </div>
                      <div class="_ag-about-sc">
                        <h2><span class="material-icons">assignment</span> Overview</h2>
                        {% if agent.about %}
                        <p>{{agent.about|safe}}</p>
                        {% else %}
                        <div class="pflpages-no-results">
                          <img src="{%static 'img/note.svg'%}" alt="empty">
                          <p>Nothing yet</p>
                        </div>
                        {% endif %}
                      </div>
                      <div class="_ag-about-sc">
                        <h2><span class="material-icons">verified</span> Speciality</h2>
                        <div class="_ag-skillBtns">
                              <button type="button" name="button">Property Management</button>
                        </div>
                      </div>
                      <div class="_ag-about-sc">
                        <h2><span class="material-icons">group</span> Our top clients</h2>
                        <div class="_ag-clients {% if top_clients %}owl-carousel {% endif %}">
                          {% if top_clients %}
                            {% for top_client in top_clients %}
                              <div class="_ag-clientsCard card">
                                  <div class="_ag-clientsCardImg">
                                    {% cloudinary top_client.client_logo %}
                                  </div>
                                  <div class="_ag-clientsCardDt">
                                    <h5>{{top_client.client_name}}</h5>
                                    <h6>{{top_client.business_category}}</h6>
                                  </div>
                              </div>
                            {% endfor %}
                          {%else %}
                            <div class="pflpages-no-results">
                              <img src="{%static 'img/note.svg'%}" alt="empty">
                              <p>Nothing Yet</p>
                            </div>
                          {% endif %}
                        </div>
                      </div>
                      <div class="_ag-about-sc">
                        <h2><span class="material-icons">pin_drop</span> Service areas</h2>
                        <div class="_ag-serviceAreas">
                            {% if agent.service_areas%}
                                {% for service_area in agent.service_areas%}
                                <form class="_ag-svcAreafORM" action="{% url 'profiles:pm_list' %}" method="get">
                                  {%csrf_token%}
                                    <button type="submit" name="ag-location" value="{{service_area}}">{{service_area}}</button>
                                </form
                                {% endfor %}
                            {% else %}
                                <div class="pflpages-no-results">
                                  <img src="{%static 'img/note.svg'%}" alt="empty">
                                  <p>Nothing Yet</p>
                                </div>
                            {% endif %}
                        </div>
                      </div>
                  </div>
              </div>
              <div class="Pr-sr-lsts-vw" id="pm-sr-lsts-vw">
                <div class="ag-sr-m-sc">
                  <div class="_pf_sectionHeader">
                    <h1>Listings Distribution</h1>
                  </div>
                  <li><i class="fas fa-circle" style="color:red;"></i>For Sale ({{s_count}})
                    <i class="fas fa-circle" style="color:blue;"></i>For Rent ({{r_count}})</li>
                  <div id='ag-d-sr-map'>

                  </div>
                </div>
                <div class="ag-sr-lsts">
                  <div class="_pf_sectionHeader">
                    <h1>What we are selling</h1>
                  </div>
                  <table>
                    <tr>
                      <th>Property</th>
                      <th>Address</th>
                      <th>Baths</th>
                      <th>Beds</th>
                      <th>Price</th>
                    </tr>
                    {% for listings in sale_listings_p %}
                    <tr>
                      <td><a href="{% url 'listings:onsale_detail' listings.pk %}"><img src="{% cloudinary_url listings.thumb ImageTransformation %}" alt="{{listings.property_name}}" width="100px" height=50px></a></td>
                      <td><a href="{% url 'listings:onsale_detail' listings.pk %}">{{listings.location_name}}</a></td>
                      <td>{{listings.bathrooms}}</td>
                      <td>{{listings.bedrooms}}</td>
                      <td>{{listings.price}}</td>

                    </tr>
                    {% endfor %}
                  </table>
                  <div class="s_l_pgnt">
                    {% include 'profiles/pagination.html' with listings=sale_listings_p %}
                  </div>
                  <div class="_pf_sectionHeader">
                    <h1>What we are renting</h1>
                  </div>
                  <table>
                    <tr>
                      <th>Property</th>
                      <th>Address</th>
                      <th>Baths</th>
                      <th>Beds</th>
                      <th>Price</th>
                    </tr>
                    {% for listings in rental_listings_p %}
                    <tr>
                      <td><a href="{% url 'listings:onsale_detail' listings.pk %}"><img src="{% cloudinary_url listings.thumb ImageTransformation %}" alt="{{listings.property_name}}" width="100px" height="50px"></a></td>
                      <td><a href="{% url 'listings:onsale_detail' listings.pk %}">{{listings.location_name}}</a></td>
                      <td>{{listings.bathrooms}}</td>
                      <td>{{listings.bedrooms}}</td>
                      <td>{{listings.price}}</td>

                    </tr>
                    {% endfor %}
                  </table>
                  <div class="s_l_pgnt">
                    {% include 'profiles/pagination.html' with listings=rental_listings_p %}
                  </div>
                </div>
              </div>
              <div class="Pr-Portfolio-vw" id="pm-Portfolio-vw">
                  <div class="pro-portfolio">
                    <div class="_pf_sectionHeader">
                      <h1>Properties managed</h1>
                    </div>
                    <div class="_pf-items">
                        {% if management_portfolio %}
                          {% for propManaged in management_portfolio %}
                          <div class="pro-pofo-item card">
                              <div class="pro-pf-img-slider">
                                  <div  class="portf-slider carousel carousel-slider" data-indicators="true">
                                    {% for image in propManaged.PM_porfolio_Images.all%}
                                    <a href="#{{image.property_image}}!" class="carousel-item" data-cindex='{{image.property_image}}' >
                                      {% cloudinary image.property_image ImageTransformation %}</a>
                                    {% endfor %}
                                    <div class="prev">
                                      <img src="{% static 'img/circled_back_arrow.svg'%}" alt="prev">
                                    </div>
                                    <div class="next">
                                      <img src="{% static 'img/circled_next_arrow.svg'%}" alt="next">
                                    </div>
                                  </div>
                              </div>
                              <div class="pro-pf-text-box">
                                  <div class="pro-pf-dR">
                                    <div class="proPf-t-wrp">
                                      <h5>{{propManaged.property_name}}</h5>
                                      <h6>{{propManaged.property_location}}</h6>
                                      <li><b>Valued at approx:</b>
                                      <br>
                                        Ksh: {{propManaged.property_market_value}}
                                      </li>
                                      {% if propManaged.property_market_value == 'Yes'%}
                                      <li><span>Currently managing</span></li>
                                      {%else%}
                                      <li><span>Currently managing</span></li>
                                      {% endif %}
                                    </div>
                                    <div class="proPf-t-fla-b">
                                      <a href="#portfolioReport" class="modal-trigger">
                                        <button type="button" name="button">
                                          <span class="material-icons">flag</span>
                                        </button>
                                      </a>
                                    </div>
                                  </div>
                                  <a href="#portf-detail-modal" class="ptf-D-trigger modal-trigger">
                                    <button type="button" name="button">View</button>
                                  </a>
                              </div>
                          </div>
                          <div id="portf-detail-modal" class="modal">
                            <div class="ag-modalHeader">
                              <h1>Property's Details</h1>
                              <button type="button" class='modal-close'>
                                <span class="material-icons">close</span>
                              </button>

                            </div>
                            <div class="ptfDMoWrappper">
                                <div class="PDM-imageSliderBox">
                                  <div  class="PDM-Islider carousel carousel-slider" data-indicators="true">
                                    {% for image in propManaged.PM_porfolio_Images.all%}
                                    <a href="#{{image.property_image}}!" class="carousel-item" data-cindex='{{image.property_image}}' >
                                      {% cloudinary image.property_image ImageTransformation %}</a>
                                    {% endfor %}
                                    <div class="prev">
                                      <img src="{% static 'img/circled_back_arrow.svg'%}" alt="prev">
                                    </div>
                                    <div class="next">
                                      <img src="{% static 'img/circled_next_arrow.svg'%}" alt="next">
                                    </div>
                                  </div>
                                </div>
                                <div class="PDM-DetailsBox">
                                  <div class="PDM-Dtxt">
                                      <div class="PDM-Dtxt-header">
                                        {{propManaged.property_name}}
                                        <div class="proPf-t-fla-b">
                                          <a href="#portfolioReport" class="modal-trigger">
                                            <button type="button" name="button">
                                              <span class="material-icons">flag</span>
                                            </button>
                                          </a>
                                        </div>
                                      </div>
                                      <ul>
                                        <li>Location<br><span>{{propManaged.property_location}}</span></li>
                                        <li>Aproximate Value<br><span>Ksh {{propManaged.property_market_value}}</span></li>
                                        <li>Management Status<br>
                                          {% if propManaged.currently_managing == 'Yes'  %}
                                            <span>Ongoing</span>
                                          {% else %}
                                            <span>Ended</span>
                                          {% endif %}
                                        </li>
                                      </ul>
                                  </div>
                                </div>
                            </div>
                          </div>
                          <div id="portfolioReport" class="modal">
                            <div class="reportformWp">
                                <div class="ag-modalHeader">
                                  <h1>Report a problem</h1>
                                  <button type="button" class='modal-close'>
                                    <span class="material-icons">close</span>
                                  </button>
                                </div>
                                  <form class="reportform" action="{% url 'contact:p_p_report' %}" method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="rFo-Sub-user-pk" value="{{agent.user.pk}}">
                                    <input type="hidden" name="rFo-Sub-project-pk" value="{{propManaged.pk}}">
                                    <input type="hidden" name="rFo-current-path" value="{{request.build_absolute_uri}}">
                                      <div class="reportformSeF input-field col s12">
                                        <p>Problem</p>
                                       <select name="rFo-Problem">
                                         <option value="" disabled selected>Select one</option>
                                         <option value="1">Offensive content</option>
                                         <option value="2">Irrelevant content</option>
                                         <option value="3">Innacurate information</option>
                                         <option value="4">Other</option>
                                        </select>
                                     </div>
                                     <div class="reportformTeAWrp col s12">
                                       <p>Details</p>
                                       <textarea rows="20" cols="80" placeholder="optional" name="rFo-Details"></textarea>
                                     </div>
                                     <div class="reportformInput col s12">
                                       <p>Your email</p>
                                       <input type="text" name="rFo-Email">
                                     </div>
                                     <div class="reportSubmitBtn col s12">
                                       <button type="submit">Submit</button>
                                     </div>
                                  </form>
                            </div>
                          </div>
                          {% endfor %}
                        {% else %}
                        <div class="pflpages-no-results">
                          <img src="{%static 'img/note.svg'%}" alt="empty">
                          <p>No results found</p>
                        </div>
                        {% endif %}
                    </div>
                  </div>
              </div>
        </div>
        <div class="ag-d-right-content">
          <div class="_ag-connections card">
            <div class="_ag-connectionsHeader">
              <h1>Connections <span>{{pro_teammates.count}}</span></h1>
              <a href="#pm-Team-vw" class='modal-trigger'>Show All</a>
            </div>
            <div class="_ag-cns-content">
              {% if pro_teammates %}
                  {% for connection in pro_teammates%}
                    {% if agent.user == connection.requestor %}
                    <div class="_ag-cns-user">
                      <div class="_ag-cns-imgWrp">
                          <img src="{{connection.receiver.profile_image.url}}">
                      </div>
                      <div class="_ag-cns-Dtls">
                          <h5>{% if connection.receiver.get_full_name %}{{connection.receiver.get_full_name}} {% else %} {{connection.receiver.username}}{% endif %}</h5>
                          <h6>{{connection.receiver.user_type}}</h6>
                      </div>
                      <div class="_ag-cns-Cta">
                        <a href="
                          {% if connection.receiver.user_type == 'Agent' %}
                              {% url 'profiles:agent_detail' connection.receiver.agent_profile.pk %}
                          {% elif connection.receiver.user_type == 'PropertyManager' %}
                              {% url 'profiles:pm_detail' connection.receiver.pm_profile.pk %}
                          {% elif connection.receiver.user_type == 'Design&servicePro' %}
                              {% url 'profiles:d_service_detail' connection.receiver.DService_profile.pk %}
                          {% elif connection.receiver.user_type == 'Company' %}
                              {% url 'profiles:business_detail' connection.receiver.company_profile.pk %}
                          {% endif %}
                        ">
                        <span class="material-icons" style="border:1px solid #ddd">chevron_right</span>
                      </a>
                      </div>
                    </div>
                    {% elif agent.user == connection.receiver%}
                    <div class="_ag-cns-user">
                      <div class="_ag-cns-imgWrp">
                          <img src="{{connection.requestor.profile_image.url}}">
                      </div>
                      <div class="_ag-cns-Dtls">
                          <h5>{% if connection.requestor.get_full_name %}{{connection.requestor.get_full_name}} {% else %} {{connection.requestor.username}}{% endif %}</h5>
                          <h6>{{connection.requestor.user_type}}</h6>
                      </div>
                      <div class="_ag-cns-Cta">
                        <a href="
                          {% if connection.requestor.user_type == 'Agent' %}
                              {% url 'profiles:agent_detail' connection.requestor.agent_profile.pk %}
                          {% elif connection.requestor.user_type == 'PropertyManager' %}
                              {% url 'profiles:pm_detail' connection.requestor.pm_profile.pk %}
                          {% elif connection.requestor.user_type == 'Design&servicePro' %}
                              {% url 'profiles:d_service_detail' connection.requestor.DService_profile.pk %}
                          {% elif connection.requestor.user_type == 'Company' %}
                              {% url 'profiles:business_detail' connection.requestor.company_profile.pk %}
                          {% endif %}
                        ">
                        <span class="material-icons" style="border:1px solid #ddd">chevron_right</span>
                      </a>
                      </div>
                    </div>
                    {% endif %}
                  {% endfor %}
              {% else %}
                <div class="pflpages-no-results">
                  <p>Nothing yet.</p>
                </div>
              {% endif %}
            </div>
          </div>
          <br>
          <br>
          <div class="_ag-connections card">
            <div class="_ag-connectionsHeader">
              <h1>Reviews <span>{{reviews_count}}</span></h1>
              <a href="#pm-reviews-vw" class='modal-trigger' >Show All</a>
            </div>
            <div class="_ag-cns-ratingWrp">
              <div class="_ag-cns-OvRt">
                Overral Rating
                <div class="_ag-cns-OvRtScore">
                  {% if average_rating.rating__avg %}
                    <span>{{average_rating.rating__avg|floatformat}}</span>/5
                  {% else %}
                    <span>0</span>/5
                  {% endif %}
                </div>
              </div>
              <div class="_ag-cns-rating">
                {% if average_rating.rating__avg %}
                    {% if average_rating.rating__avg  > 4.5  and average_rating.rating__avg <= 5 %}
                    <li> <span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span></li>
                    {%elif average_rating.rating__avg > 3.5 and average_rating.rating__avg <= 4.5 %}
                    <li> <span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span></li>
                    {% elif average_rating.rating__avg > 2.5 and average_rating.rating__avg <= 3.5 %}
                    <li> <span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                    {% elif average_rating.rating__avg > 1.5 and average_rating.rating__avg <= 2.5 %}
                    <li> <span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                    {% elif average_rating.rating__avg > 0 and average_rating.rating__avg <= 1.5 %}
                    <li> <span class="material-icons">star_rate</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                    {% else %}
                    <li> <span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                    {% endif %}
                {% else %}
                <li> <span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                {% endif %}
              </div>
            </div>
            <div class="_ag-cns-content">
              {% if company_reviews %}
              {% for review in company_reviews%}
                <div class="_ag-cns-user">
                  <div class="_ag-cns-imgWrp">
                      <img src="{% if review.user.profile_image %}{{review.user.profile_image.url}}{% else %} {% static 'img/avatar.png' %}{% endif %}">
                  </div>
                  <div class="_ag-cns-Dtls">
                      <h5>{% if review.user.get_full_name %}{{review.user.get_full_name}} {% else %} {{review.user.username}}{% endif %}</h5>
                      <h6>{% if review.user.user_type == 'NormalUser' %}Rehgien User {%else%}{{review.user.user_type}}{%endif%}</h6>
                  </div>
                  <div class="_ag-cns-Cta">
                    <button type="button" name="button">
                      <span class="material-icons">star_rate</span>{{review.rating}}
                    </button>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <div class="pflpages-no-results">
                  <p>Nothing yet.</p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<div class="Pr-Members-vw modal" id="pm-Team-vw">
  <div class="bsTeamMembers">
      <div class="ag-modalHeader">
        <h1>Connections
          <div id="_helperBox">
            <span id="_helperTextTrigger" class="material-icons" >help</span>
           <div id="_helperText">
             <button id="_helperTextHide" type="button" name="button">
               <span class="material-icons" >close</span>
             </button>
             <div>
               This pro and their connections below have a professional relationship.
               They consist of professionals they know or work with and are listed here only for the purpose of their mutual
               endorsement in the Rehgien pro directories.
               <a href="#">Learn More</a>
             </div>
           </div>
         </div>
        </h1>
        <button type="button" class='modal-close'>
          <span class="material-icons">close</span>
        </button>
      </div>
      {% if pro_teammates%}
          <div class="bsTMembersCards">
             {% for teammate in pro_teammates%}
              {% if agent.user == teammate.requestor %}
                <div class="bsTMembersWrp">
                    <div class="bsTMbImg-wrp">
                      <a href="
                      {% if teammate.receiver.user_type == 'Agent' %}
                          {% url 'profiles:agent_detail' teammate.receiver.agent_profile.pk %}
                      {% elif teammate.receiver.user_type == 'PropertyManager' %}
                          {% url 'profiles:pm_detail' teammate.receiver.pm_profile.pk %}
                      {% elif teammate.receiver.user_type == 'Design&servicePro' %}
                          {% url 'profiles:d_service_detail' teammate.receiver.DService_profile.pk %}
                      {% elif teammate.receiver.user_type == 'Company' %}
                          {% url 'profiles:business_detail' teammate.receiver.company_profile.pk %}
                      {% endif %}
                      ">
                        <img src="
                        {% if teammate.receiver.profile_image %}
                        {{teammate.receiver.profile_image.url}}
                        {% else %}
                          {% static 'img/avatar.png'%}
                        {% endif %}
                        ">
                      </a>
                    </div>
                    <div class="bsTMbI-wrp">
                      <li><i class="fas fa-star fa-2x" style='color:#1BFF00'></i>
                        {% if teammate.receiver.user_type == 'Agent' %}
                            {% if teammate.receiver.agent_profile.average_rating > 0 %}
                              {{teammate.receiver.agent_profile.average_rating}}/5 ({{teammate.receiver.agent_profile.agent_review.all.count}} Reviews)
                            {% else %}
                              0 Reviews
                            {% endif %}
                        {% elif teammate.receiver.user_type == 'PropertyManager' %}
                            {% if teammate.receiver.pm_profile.average_rating > 0 %}
                              {{teammate.receiver.pm_profile.average_rating}}/5 ({{teammate.receiver.pm_profile.pm_review.all.count}} Reviews)
                            {% else %}
                              0 Reviews
                            {% endif %}
                        {% elif teammate.receiver.user_type == 'Design&servicePro' %}
                            {% if teammate.receiver.DService_profile.average_rating > 0 %}
                              {{teammate.receiver.DService_profile.average_rating}}/5 ({{teammate.receiver.DService_profile.DService_review.all.count}} Reviews)
                            {% else %}
                              0 Reviews
                            {% endif %}
                        {% elif teammate.receiver.user_type == 'Company' %}
                            {% if teammate.receiver.company_profile.average_rating > 0 %}
                              {{teammate.receiver.company_profile.average_rating}}/5 ({{teammate.receiver.company_profile.company_review.all.count}} Reviews)
                            {% else %}
                              0 Reviews
                            {% endif %}
                        {% endif %}
                       </li>
                      {{teammate.receiver.get_full_name}}
                    </div>
                </div>
              {% elif  agent.user == teammate.receiver%}
                <div class="bsTMembersWrp">
                    <div class="bsTMbImg-wrp">
                      <a href="
                      {% if teammate.requestor.user_type == 'Agent' %}
                          {% url 'profiles:agent_detail' teammate.requestor.agent_profile.pk %}
                      {% elif teammate.requestor.user_type == 'PropertyManager' %}
                          {% url 'profiles:pm_detail' teammate.requestor.pm_profile.pk %}
                      {% elif teammate.requestor.user_type == 'Design&servicePro' %}
                          {% url 'profiles:d_service_detail' teammate.requestor.DService_profile.pk %}
                      {% elif teammate.requestor.user_type == 'Company' %}
                          {% url 'profiles:business_detail' teammate.requestor.company_profile.pk %}
                      {% endif %}
                      ">
                        <img src="
                        {% if teammate.requestor.profile_image %}
                        {{teammate.requestor.profile_image.url}}
                        {% else %}
                          {% static 'img/avatar.png'%}
                        {% endif %}
                        ">
                      </a>
                    </div>
                    <div class="bsTMbI-wrp">
                      <li><i class="fas fa-star fa-2x" style='color:#1BFF00'></i>
                        {% if teammate.requestor.user_type == 'Agent' %}
                            {% if teammate.requestor.agent_profile.average_rating > 0 %}
                              {{teammate.requestor.agent_profile.average_rating}}/5 ({{teammate.requestor.agent_profile.agent_review.all.count}} Reviews)
                            {% else %}
                              0 Reviews
                            {% endif %}
                        {% elif teammate.requestor.user_type == 'PropertyManager' %}
                            {% if teammate.requestor.pm_profile.average_rating > 0 %}
                              {{teammate.requestor.pm_profile.average_rating}}/5 ({{teammate.requestor.pm_profile.pm_review.all.count}} Reviews)
                            {% else %}
                              0 Reviews
                            {% endif %}
                        {% elif teammate.requestor.user_type == 'Design&servicePro' %}
                            {% if teammate.requestor.DService_profile.average_rating > 0 %}
                              {{teammate.requestor.DService_profile.average_rating}}/5 ({{teammate.requestor.DService_profile.DService_review.all.count}} Reviews)
                            {% else %}
                              0 Reviews
                            {% endif %}
                        {% elif teammate.requestor.user_type == 'Company' %}
                            {% if teammate.requestor.company_profile.average_rating > 0 %}
                              {{teammate.requestor.company_profile.average_rating}}/5 ({{teammate.requestor.company_profile.company_review.all.count}} Reviews)
                            {% else %}
                              0 Reviews
                            {% endif %}
                        {% endif %}
                       </li>
                      {{teammate.requestor.get_full_name}}
                    </div>
                </div>
              {%endif%}
            {% endfor %}
          </div>
      {% else %}
          <div class="pflpages-no-results">
            <img src="{%static 'img/note.svg'%}" alt="empty">
            <p>No connections availlable</p>
          </div>
      {% endif %}
  </div>
</div>
<div class="Pr-reviews-vw modal" id="pm-reviews-vw">
  <div class="reviews-section">
        <div class="ag-modalHeader">
          <h1>Reviews</h1>
          <button type="button" class='modal-close'>
            <span class="material-icons">close</span>
          </button>
        </div>
        <div class="goToReviewButton">
          <form class="goToReviewForm" action="{% url 'profiles:pm_review'%}" method="GET">
              <button type="submit" name="agr" value="{{agent.pk}}" >Write a review > </button>
          </form>
        </div>
        <div class="review-comments">
          {% if agent_reviews %}
          {% for reviews in agent_reviews%}
          <div class="review-wrapper">
              <div class="revCo-header">
                <div class="revCo-h-ar-reP">
                    {% if reviews.rating == 5%}
                    <h2>
                        <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span></li>
                      Highly likely to recommend.
                    </h2>
                    {% endif %}
                    {% if reviews.rating == 4%}
                    <h2>
                      <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span></li>
                      Likely to recommend.
                    </h2>
                    {% endif %}
                    {% if reviews.rating == 3%}
                    <h2>
                      <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                      Slightly likely to recommend.</h2>
                    {% endif %}
                    {% if reviews.rating == 2%}
                    <h2>
                      <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                      Not likely to recommend.</h2>
                    {% endif %}
                    {% if reviews.rating == 1%}
                    <h2>
                      <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                      Never likely to recomend.</h2>
                    {% endif %}
                    <div class="proPf-t-fla-b">
                      <a href="#reviewReport" class="modal-trigger">
                        <button type="button" name="button">
                          <span class="material-icons">flag</span>
                        </button>
                      </a>
                    </div>
                </div>
                <div class="revCo-or">
                  <div style="margin-bottom:10px;">{{reviews.review_date.date}} - {{reviews.user.username}}</div>
                  {% if reviews.responsive_rating == 5%}
                  <div>
                    Responsiveness:
                    <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span></li>
                  </div>
                  {% endif %}
                  {% if reviews.responsive_rating == 4%}
                  <div>
                    Responsiveness:
                    <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span></li>
                  </div>
                  {% endif %}
                  {% if reviews.responsive_rating == 3%}
                  <div>
                    Responsiveness:
                    <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                  </div>
                  {% endif %}
                  {% if reviews.responsive_rating == 2%}
                  <div>
                    Responsiveness:
                    <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                  </div>
                  {% endif %}
                  {% if reviews.responsive_rating == 1%}
                  <div>
                    Responsiveness:
                    <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                  </div>
                  {% endif %}
                  {% if reviews.knowledge_rating == 5%}
                  <div>
                    Local Knowledge:
                    <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span></li>
                  </div>
                  {% endif %}
                  {% if reviews.knowledge_rating == 4%}
                  <div>
                    Local Knowledge:
                    <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span></li>
                  </div>
                  {% endif %}
                  {% if reviews.knowledge_rating == 3%}
                  <div>
                    Local Knowledge:
                    <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                  </div>
                  {% endif %}
                  {% if reviews.knowledge_rating == 2%}
                  <div>
                    Local Knowledge:
                    <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                  </div>
                  {% endif %}
                  {% if reviews.knowledge_rating == 1%}
                  <div>
                    Local Knowledge:
                    <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                  </div>
                  {% endif %}
                  {% if reviews.negotiation_rating == 5%}
                  <div>
                    Negotiation Skills:
                    <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span></li>
                  </div>
                  {% endif %}
                  {% if reviews.negotiation_rating == 4%}
                  <div>
                    Negotiation Skills:
                    <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span></li>
                  </div>
                  {% endif %}
                  {% if reviews.negotiation_rating == 3%}
                  <div>
                    Negotiation Skills:
                    <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                  </div>
                  {% endif %}
                  {% if reviews.negotiation_rating == 2%}
                  <div>
                    Negotiation Skills:
                    <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                  </div>
                  {% endif %}
                  {% if reviews.negotiation_rating == 1%}
                  <div>
                    Negotiation Skills:
                    <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                  </div>
                  {% endif %}
                  {% if reviews.professionalism_rating == 5%}
                  <div>
                    Professional Conduct:
                    <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span></li>
                  </div>
                  {% endif %}
                  {% if reviews.professionalism_rating == 4%}
                  <div>
                    Professional Conduct:
                    <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span></li>
                  </div>
                  {% endif %}
                  {% if reviews.professionalism_rating == 3%}
                  <div>
                    Professional Conduct:
                    <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                  </div>
                  {% endif %}
                  {% if reviews.professionalism_rating == 2%}
                  <div>
                    Professional Conduct:
                    <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                  </div>
                  {% endif %}
                  {% if reviews.professionalism_rating == 1%}
                  <div>
                    Professional Conduct:
                    <li><span class="material-icons">star_rate</span><span class="material-icons">star_rate</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span><span class="material-icons">star_outline</span></li>
                  </div>
                  {% endif %}
                </div>
              </div>
              <div class="revCO-content">
                <p>{{ reviews.comment}}</p>
              </div>
          </div>
          <div id="reviewReport" class="modal">
            <div class="reportformWp">
                <div class="reportformHeader">
                  <h1>Report a problem</h1>
                  <button type="button" class='modal-close'>
                    <span class="material-icons">close</span>
                  </button>
                </div>
                  <form class="reportform" action="{% url 'contact:review_report' %}" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="rFo-Sub-user-pk" value="{{agent.user.pk}}">
                    <input type="hidden" name="rFo-Sub-review-pk" value="{{reviews.pk}}">
                    <input type="hidden" name="rFo-current-path" value="{{request.build_absolute_uri}}">
                      <div class="reportformSeF input-field col s12">
                        <p>Problem</p>
                       <select name="rFo-Problem">
                         <option value="" disabled selected>Select one</option>
                         <option value="1">Offensive Language</option>
                         <option value="2">Appears Fake</option>
                         <option value="3">Inaccurate review</option>
                         <option value="4">Other</option>
                        </select>
                     </div>
                     <div class="reportformTeAWrp col s12">
                       <p>Details</p>
                       <textarea rows="20" cols="80" placeholder="optional" name="rFo-Details"></textarea>
                     </div>
                     <div class="reportformInput col s12">
                       <p>Your email</p>
                       <input type="text" name="rFo-Email">
                     </div>
                     <div class="reportSubmitBtn col s12">
                       <button type="submit">Submit</button>
                     </div>
                  </form>
            </div>
          </div>
        {% endfor %}
        {% else %}
          <div class="no-reviews">
            <h2>No reviews for this agent.</h2>
          </div>
        {% endif %}
    </div>
  </div>
</div>
<div id="_contactProModal" class="modal">
    <div class="ag-contact-wrapper col s12">
      <div class="ag-modalHeader">
        <h1>Contact {{agent.user.first_name}}</h1>
        <button type="button" class='modal-close'>
          <span class="material-icons">close</span>
        </button>
      </div>
    <div class="ag-d-contact">
      <form id="ag-d-contact" action="{% url 'contact:contact_pro' %}" class="col s12" method="POST">
        {% csrf_token %}
        <div class="ag-d-contactDetails">
          <input type="hidden" name="recepient" value="{{agent.user.email}}" class="validate">
          <input type="hidden" name="recepientPhoneNumber" value="{{agent.phone}}">
          <input type="hidden" name="currentPath" value="{{ request.build_absolute_uri }}">
        </div>
        <div id="n_p_r">
          <br>
          Your Name
          <div class="input-field ">
            <input id="c_name" type="text" name="name" class="validate" placeholder="Your Name">
          </div>
          <br>
          Your Phone Number
          <div class="input-field">
            <input id="c_phone_number" type="number" name="phone_number" min="0" class="validate" placeholder="Phone number">
          </div>
        </div>
        <div id="e_r">
          <br>
          Your email
          <div class="input-field">
            <input id="c_email" type="email" name="from_email" class="validate" placeholder="Your Email">
          </div>
        </div>
        <div id="c_r">
          <br>
          Your message
          <div class="input-field">
            <textarea id="message" rows="4" name="message"></textarea>
          </div>
        </div>
        <div id="c_b">
          <button id="c_SendButton" type="submit" name="button"> Send Message</button>
        </div>
      </form>
    </div>
    </div>
</div>
<div id="problemReport" class="modal">
  <div class="reportformWp">
      <div class="ag-modalHeader">
        <h1>Report a problem</h1>
        <button type="button" class='modal-close'>
          <span class="material-icons">close</span>
        </button>
      </div>
        <form class="reportform" action="{% url 'contact:page_report'%}" method="post">
          {% csrf_token %}
          <input type="hidden" name="rFo-current-path" value="{{request.build_absolute_uri}}">
          <input type="hidden" name="rFo-Sub-user-pk" value="{{agent.user.pk}}">
            <div class="reportformSeF input-field col s12">
              <p>Problem</p>
             <select name="rFo-Problem">
               <option value="" disabled selected>Select one</option>
               <option value="1">Offensive content</option>
               <option value="2">Irrelevant content</option>
               <option value="3">Spam (Self promotion)</option>
               <option value="4">False content</option>
               <option value="5">Other</option>
              </select>
           </div>
           <div class="reportformTeAWrp col s12">
             <p>Details</p>
             <textarea rows="20" cols="80" placeholder="optional" name="rFo-Details"></textarea>
           </div>
           <div class="reportformInput col s12">
             <p>Your email</p>
             <input type="text" name="rFo-Email">
           </div>
           <div class="reportSubmitBtn col s12">
             <button type="submit">Submit</button>
           </div>
        </form>
  </div>
</div>
</div>


  <script type="text/javascript">
    mapboxgl.accessToken = 'pk.eyJ1IjoicmV5a2VubmVkeSIsImEiOiJjam9td3ZkMnYwdjB5M3ZueWQ1YzVocThwIn0.PBVWnwga3qG6KX6_CoPy8g';
    if (!mapboxgl.supported()) {
      alert('Your browser does not support Mapbox GL. To access map features chooses a different browser!');
      } else {
        var map = new mapboxgl.Map({
            container: 'ag-d-sr-map',
            style: 'mapbox://styles/reykennedy/cjr359eyw0t9n2rrzr4fbv8uy',
            minZoom: 6,
            maxZoom:14,
            center: [37.01, -1.10]
      });
    }
    //fit to bounds
    map.fitBounds([
    {%for cd in sale_listings %}
      [{{cd.location.x}}, {{cd.location.y}}],
    {%endfor%}
    {%for cd in rental_listings %}
      [{{cd.location.x}}, {{cd.location.y}}],
    {%endfor%}
    ]);
    // disable map rotation using right click + drag
    map.dragRotate.disable();

    // disable map rotation using touch rotation gesture
    map.touchZoomRotate.disableRotation();


    // Adds zoom and rotation controls to the map.
    map.addControl(new mapboxgl.NavigationControl());

    var s_geojson = {
    type: 'FeatureCollection',
    features: [
    {% for loc in sale_listings %}
        {
        type: 'Feature',
        geometry: {
            type: 'Point',
            coordinates: [{{ loc.location.x }}, {{ loc.location.y }}]
        },
        properties: {
            title: '{{ loc.property_name }}',
            thumb:'{% cloudinary_url loc.thumb ImageTransformation %}',
            location_name:'{{loc.location_name}}',
            price:'{{loc.price}}',
        }
        },
    {% endfor %}
    ]
    };

    var r_geojson = {
    type: 'FeatureCollection',
    features: [
    {% for loc in rental_listings %}
        {
        type: 'Feature',
        geometry: {
            type: 'Point',
            coordinates: [{{ loc.location.x }}, {{ loc.location.y }}]
        },
        properties: {
            title: '{{ loc.property_name }}',
            thumb:'{% cloudinary_url loc.thumb ImageTransformation %}',
            location_name:'{{loc.location_name}}',
            price:'{{loc.price}}',
        }
        },
    {% endfor %}
    ]
    };

    //loading sale data
    map.on('load', function() {
      map.addSource('s_property',{
        "type": "geojson",
        "data": s_geojson
      });

      //loading rental data
      map.addSource('r_property',{
        "type": "geojson",
        "data": r_geojson
      });

      //sales layer
      map.addLayer({
      "id": "s_points",
      "source": 's_property',
      "type": "circle",
      "paint": {
          "circle-radius": 6,
          "circle-stroke-width": 1.5,
          "circle-color": "red",
          "circle-stroke-color":"white"
      },
    });

    //rentals layer
    map.addLayer({
    "id": "r_points",
    "source": 'r_property',
    "type": "circle",
    "paint": {
        "circle-radius": 6,
        "circle-stroke-width": 1.5,
        "circle-color": "blue",
        "circle-stroke-color":"white"
    },
  });

  var popup = new mapboxgl.Popup({
  closeButton: false,
  closeOnClick: false
  });

//sale listings
  map.on('mouseenter', 's_points', function(e) {
  // Change the cursor style as a UI indicator.
  map.getCanvas().style.cursor = 'pointer';

  var coordinates = e.features[0].geometry.coordinates.slice();

  // Ensure that if the map is zoomed out such that multiple
  // copies of the feature are visible, the popup appears
  // over the copy being pointed to.
  while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
  coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
  }

  // Populate the popup and set its coordinates
  // based on the feature found.
    popup
    .setLngLat(coordinates)
    .setHTML(
    '<div id="popup" class="popup" style="z-index: 10;">' +
      '<img '+ 'src=' + e.features[0].properties.thumb + '>' +"</li>"+
      '<li>' +
      '<ul class="list-group">' +
      '<li class="list-group-item">' + e.features[0].properties.title +" </li>" +
      '<li class="list-group-item">' + e.features[0].properties.location_name +" </li>"+
      '<li class="list-group-item">' +"Ksh:" + e.features[0].properties.price+ " </li>" + '</ul> </div>'
    )
    .addTo(map);
  });

  //rentals popup
  map.on('mouseenter', 'r_points', function(e) {
  // Change the cursor style as a UI indicator.
  map.getCanvas().style.cursor = 'pointer';

  var coordinates = e.features[0].geometry.coordinates.slice();

  // Ensure that if the map is zoomed out such that multiple
  // copies of the feature are visible, the popup appears
  // over the copy being pointed to.
  while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
  coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
  }

  // Populate the popup and set its coordinates
  // based on the feature found.
    popup
    .setLngLat(coordinates)
    .setHTML(
    '<div id="popup" class="popup" style="z-index: 10;">' +
      '<img '+ 'src=' + e.features[0].properties.thumb + '>' +"</li>"+
      '<li>' +
      '<ul class="list-group">' +
      '<li class="list-group-item">' + e.features[0].properties.title +" </li>" +
      '<li class="list-group-item">' + e.features[0].properties.location_name +" </li>"+
      '<li class="list-group-item">' +"Ksh:" + e.features[0].properties.price+ " </li>" + '</ul> </div>'
    )
    .addTo(map);
  });

  map.on('mouseleave', 's_points', function() {
    map.getCanvas().style.cursor = '';
    popup.remove();
  });

  map.on('mouseleave', 'r_points', function() {
    map.getCanvas().style.cursor = '';
    popup.remove();
  });

  })

  </script>

<script type="text/javascript">
  function scrollTo(to, duration) {
    if (document.body.scrollTop == to) return;
    var diff = to - document.body.scrollTop;
    var scrollStep = Math.PI / (duration / 10);
    var count = 0, currPos;
    start = window.pageYOffset;
    scrollInterval = setInterval(function(){

      if((document.body.scrollTop || document.documentElement.scrollTop || 0)!=to){
            count++
            currPos=start+diff*(.5-.5*Math.cos(count*scrollStep))
            /* https://stackoverflow.com/q/28633221/3405291 */
            /* To support both Chromium-based and Firefox */
            document.body.scrollTop=currPos
            document.documentElement.scrollTop=currPos
        }else{clearInterval(scrollInterval)}
    },10);
}

function test(elID)
{
    var dest = document.getElementById(elID);
    scrollTo(dest.offsetTop, 500);
}
</script>
{% endblock %}
{% block footer %}
<footer >
<section id="footer" class="section section-follow black-text" style='background-image:none;
    background: #f1f9f1;'>
  <div class="container">
    <div class="row">
      <div class="f-details center">
        <a href="#"> Privacy Policy</a>
        <a href="#"> Terms & Conditions</a>
        <a href="#"> Advertise</a>
        <a href="#"> Contact Us</a>
        <a href="{% url 'contact:about_us'%}"> About Us</a>
      </div>
      <div id="footer-details" class="col s12 center">
        <a href="#" class="black-text">
          <i class="fab fa-facebook fa-2x"></i>
        </a>
        <a href="#" class="black-text">
          <i class="fab fa-twitter fa-2x"></i>
        </a>
        <a href="#" class="black-text">
          <i class="fab fa-linkedin fa-2x"></i>
        </a>
        <a href="#" class="black-text">
          <i class="fab fa-instagram fa-2x"></i>
        </a>
      </div>
      <p class="flow-text black-text center" id="c-year"></p>
      <script type="text/javascript">
        var d = new Date();
        document.getElementById("c-year").innerHTML= 'While using this site, you agree to have read and accepted our terms of use, cookie and privacy policy. Copyright '+ d.getFullYear();
      </script>
    </div>
  </div>
</section>

</footer>
{% endblock%}
