{% extends 'base1.html' %}
{% load static %}

{% block content %}

<section>
  <div class="container" style="width:90%;">
    <div class="row">
      <div class="col s12 md3 l3 xl3">
        <div id="ag-d-card" class="card">
            <div class="ag-d-img">
              {% if agent.profile_image%}
              <img src="{{agent.profile_image.url}}" alt="{{agent.user.first_name}}" style="width:150px;height:150px; border-radius:100%;">
              {% else %}
              <img src="{%static 'img/avatar.png'%}" alt="{{agent.user.first_name}}" style="width:150px;height:150px; border-radius:100%;">
              {% endif %}
            </div>
            <div class="ag-d-details">
              <div class="b-dtls">
                <h5> {{agent.user.first_name}} {{agent.user.last_name}}</h5>
              </div>
              <div class="ag-rating">
                <li><i class="fas fa-star-half-alt" style="color:lime;"></i> 90% rating</li>
                <li>{{s_r_total}} listings on Rehgien</li>
              </div>
              <div class="ag-d-lst">
                <li><i class="fas fa-home fa-lg" style="color:#5b0088;"></i> {{s_count}} Sale Listings</li>
                <li><i class="fas fa-sign fa-lg" style="color:#5b0088;"></i> {{r_count}} Rental Listings</li>
              </div>
              <div class="ag-d-lst">
                <li><button type="button">Review</button></li>
              </div>
            </div>
        </div>
      </div>
      <div class="col s12 md6 l6 xl6">

        <div>
          <div class="ag-about ">
            <h6>About</h6>
            {% if agent.about %}
            <p>{{agent.about|safe}}</p>
            {% else %}
            <p>Content not provided!</p>
            {% endif %}
          </div>
        </div>

      </div>

      <div class="col s12 md3 l3 xl3">
        <div class="ag-d-contact">
          <form id="ag-d-contact" action="#" class="col s12" method="POST">
            <h6><b>Contact this agent</b></h6>
            {% csrf_token %}
            <div id="n_p_r" class="row">
              <div class="input-field col s12">
                <input id="c_name" type="text" name="name" class="validate" placeholder="Your Name">
              </div>
              <div class="input-field col s12">
                <input id="c_phone_number" type="number" name="phone_number" min="0" class="validate" placeholder="Phone number">
              </div>
            </div>
            <div id="e_r" class="row">
              <div class="input-field col s12">
                <input id="c_email" type="email" name="from_email" class="validate" placeholder="Your Email">
              </div>
            </div>
            <div class="row">
              <div class="input-field col s12">
                <input disabled id="c_recepient" type="hidden" name="recepient" value="{{agent.email}}" class="validate">
              </div>
            </div>
            <div id="c_r" class="row">
              <div class="input-field col s12">
                <textarea id="message" rows="4" name="message"></textarea>
              </div>
            </div>
            <div id="c_b">
              <button id="c_SendButton" type="submit" name="button"> Send Message</button>
            </div>
          </form>
        </div>
        <div class="ag-personal-info col s12">
          <div class="ag-pl-inf">
            <h1>You can also contact us Directly</h1>
            <li>{{agent.user.email}}</li>
            <li>{{agent.phone}}</li>
          </div>
        </div>
        <div class="proffesional-dtls col s12">
          <div id="ag-o-d">
            <h1>Proffesional Details</h1>
            {% if agent.address%}
            <li><b>Address:</b><br>{{agent.address}}</li>
            {% else %}
            <li><b>Address:</b><br>Not Provided</li>
            {% endif %}
            {% if agent.website_link%}
            <li><b>Website:</b><br><a href="#" target='_blank'>www.rehgien.com</a></li>
            {% else%}
            <li><b>Website:</b><br><a href="#" target='_blank'>Not Provided</a></li>
            {% endif %}
            <li><b>Socials:</b><br>
              {% if agent.linkedin_link%}
              <a href="{{agent.linkedin_link}}" target='_blank'><i class="fab fa-linkedin"></i></a>
              {% endif %}
              {% if agent.facebook_link%}
              <a href="{{agent.facebook_link}}" target='_blank'><i class="fab fa-facebook-square"></i></a>
              {% endif%}
              {% if agent.twitter_link%}
              <a href="{{agent.twitter_link}}" target='_blank'><i class="fab fa-twitter-square"></i></a>
              {% endif%}
            </li>
            <li><b>License No:</b> {{agent.license_number}}</li>
            <li><b>Rehgien Member since</b>:{{agent.member_since.date}}</li>
          </div>
        </div>


      </div>

    </div>
  </div>
</section>
<section>
  <div class="container">
    <div class="row">
    <div class="ag-sr-m-sc col s12 md8 l8 xl8">
      <h1>Listings Distribution</h1>
      <li><i class="fas fa-circle" style="color:red;"></i>For Sale ({{s_count}})
        <i class="fas fa-circle" style="color:blue;"></i>For Rent ({{r_count}})</li>
      <div id='ag-d-sr-map'>

      </div>
    </div>
    </div>
  </div>
  <script type="text/javascript">
    mapboxgl.accessToken = 'pk.eyJ1IjoicmV5a2VubmVkeSIsImEiOiJjam9td3ZkMnYwdjB5M3ZueWQ1YzVocThwIn0.PBVWnwga3qG6KX6_CoPy8g';
    if (!mapboxgl.supported()) {
      alert('Your browser does not support Mapbox GL. To access map features chooses a different browser!');
      } else {
        var map = new mapboxgl.Map({
            container: 'ag-d-sr-map',
            style: 'mapbox://styles/reykennedy/cjr359eyw0t9n2rrzr4fbv8uy',
            minZoom: 6,
            maxZoom:14,
            center: [37.01, -1.10]
      });
    }
    //fit to bounds
    map.fitBounds([
    {%for cd in sale_listings %}
      [{{cd.location.x}}, {{cd.location.y}}],
    {%endfor%}
    {%for cd in rental_listings %}
      [{{cd.location.x}}, {{cd.location.y}}],
    {%endfor%}
    ]);
    // disable map rotation using right click + drag
    map.dragRotate.disable();

    // disable map rotation using touch rotation gesture
    map.touchZoomRotate.disableRotation();


    // Adds zoom and rotation controls to the map.
    map.addControl(new mapboxgl.NavigationControl());

    var s_geojson = {
    type: 'FeatureCollection',
    features: [
    {% for loc in sale_listings %}
        {
        type: 'Feature',
        geometry: {
            type: 'Point',
            coordinates: [{{ loc.location.x }}, {{ loc.location.y }}]
        },
        properties: {
            title: '{{ loc.property_name }}',
            thumb:'{{loc.thumb.url}}',
            location_name:'{{loc.location_name}}',
            price:'{{loc.price}}',
        }
        },
    {% endfor %}
    ]
    };

    var r_geojson = {
    type: 'FeatureCollection',
    features: [
    {% for loc in rental_listings %}
        {
        type: 'Feature',
        geometry: {
            type: 'Point',
            coordinates: [{{ loc.location.x }}, {{ loc.location.y }}]
        },
        properties: {
            title: '{{ loc.property_name }}',
            thumb:'{{loc.thumb.url}}',
            location_name:'{{loc.location_name}}',
            price:'{{loc.price}}',
        }
        },
    {% endfor %}
    ]
    };

    //loading sale data
    map.on('load', function() {
      map.addSource('s_property',{
        "type": "geojson",
        "data": s_geojson
      });

      //loading rental data
      map.addSource('r_property',{
        "type": "geojson",
        "data": r_geojson
      });

      //sales layer
      map.addLayer({
      "id": "s_points",
      "source": 's_property',
      "type": "circle",
      "paint": {
          "circle-radius": 6,
          "circle-stroke-width": 1.5,
          "circle-color": "red",
          "circle-stroke-color":"white"
      },
    });

    //rentals layer
    map.addLayer({
    "id": "r_points",
    "source": 'r_property',
    "type": "circle",
    "paint": {
        "circle-radius": 6,
        "circle-stroke-width": 1.5,
        "circle-color": "blue",
        "circle-stroke-color":"white"
    },
  });

  var popup = new mapboxgl.Popup({
  closeButton: false,
  closeOnClick: false
  });

//sale listings
  map.on('mouseenter', 's_points', function(e) {
  // Change the cursor style as a UI indicator.
  map.getCanvas().style.cursor = 'pointer';

  var coordinates = e.features[0].geometry.coordinates.slice();

  // Ensure that if the map is zoomed out such that multiple
  // copies of the feature are visible, the popup appears
  // over the copy being pointed to.
  while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
  coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
  }

  // Populate the popup and set its coordinates
  // based on the feature found.
    popup
    .setLngLat(coordinates)
    .setHTML(
    '<div id="popup" class="popup" style="z-index: 10;">' +
      '<img '+ 'src=' + e.features[0].properties.thumb + '>' +"</li>"+
      '<li>' +
      '<ul class="list-group">' +
      '<li class="list-group-item">' + e.features[0].properties.title +" </li>" +
      '<li class="list-group-item">' + e.features[0].properties.location_name +" </li>"+
      '<li class="list-group-item">' +"Ksh:" + e.features[0].properties.price+ " </li>" + '</ul> </div>'
    )
    .addTo(map);
  });

  //rentals popup
  map.on('mouseenter', 'r_points', function(e) {
  // Change the cursor style as a UI indicator.
  map.getCanvas().style.cursor = 'pointer';

  var coordinates = e.features[0].geometry.coordinates.slice();

  // Ensure that if the map is zoomed out such that multiple
  // copies of the feature are visible, the popup appears
  // over the copy being pointed to.
  while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
  coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
  }

  // Populate the popup and set its coordinates
  // based on the feature found.
    popup
    .setLngLat(coordinates)
    .setHTML(
    '<div id="popup" class="popup" style="z-index: 10;">' +
      '<img '+ 'src=' + e.features[0].properties.thumb + '>' +"</li>"+
      '<li>' +
      '<ul class="list-group">' +
      '<li class="list-group-item">' + e.features[0].properties.title +" </li>" +
      '<li class="list-group-item">' + e.features[0].properties.location_name +" </li>"+
      '<li class="list-group-item">' +"Ksh:" + e.features[0].properties.price+ " </li>" + '</ul> </div>'
    )
    .addTo(map);
  });

  map.on('mouseleave', 's_points', function() {
    map.getCanvas().style.cursor = '';
    popup.remove();
  });

  map.on('mouseleave', 'r_points', function() {
    map.getCanvas().style.cursor = '';
    popup.remove();
  });

  })

  </script>
  </section>

<section>
  <div class="container">
      <div class="row">
        <div class="ag-sr-lsts">
          <h1>What we are selling</h1>
          <table>
            <tr>
              <th>Property</th>
              <th>Address</th>
              <th>Baths</th>
              <th>Beds</th>
              <th>Price</th>
            </tr>
            {% for listings in sale_listings_p %}
            <tr>
              <td><a href="{% url 'listings:onsale_detail' listings.pk %}"><img src="{{listings.thumb.url}}" alt="{{listings.property_name}}" width="100px"></a></td>
              <td><a href="{% url 'listings:onsale_detail' listings.pk %}">{{listings.location_name}}</a></td>
              <td>{{listings.bathrooms}}</td>
              <td>{{listings.bedrooms}}</td>
              <td>{{listings.price}}</td>

            </tr>
            {% endfor %}
          </table>
          <div class="s_l_pgnt">
            <!-- paginator for rental listings-->
            {% include 'profiles/pagination.html' with listings=sale_listings_p %}
          </div>

            <h1>What we are renting</h1>
          <table>
            <tr>
              <th>Property</th>
              <th>Address</th>
              <th>Baths</th>
              <th>Beds</th>
              <th>Price</th>
            </tr>
            {% for listings in rental_listings_p %}
            <tr>
              <td><a href="{% url 'listings:onsale_detail' listings.pk %}"><img src="{{listings.thumb.url}}" alt="{{listings.property_name}}" width="100px"></a></td>
              <td><a href="{% url 'listings:onsale_detail' listings.pk %}">{{listings.location_name}}</a></td>
              <td>{{listings.bathrooms}}</td>
              <td>{{listings.bedrooms}}</td>
              <td>{{listings.price}}</td>

            </tr>
            {% endfor %}
          </table>
          <div class="s_l_pgnt">
            <!-- paginator for rental listings-->
            {% include 'profiles/pagination.html' with listings=rental_listings_p %}
          </div>
        </div>
      </div>
  </div>
</section>
{% endblock %}
{% block footer %}
<footer >
<section id="footer" class="section section-follow black-text">
  <div class="container">
    <div class="row">
      <div class="f-details center">
        <a href="#"> Privacy Policy</a>
        <a href="#"> Terms & Conditions</a>
        <a href="#"> Advertise</a>
        <a href="#"> Contact Us</a>
        <a href="{% url 'contact:about_us'%}"> About Us</a>
      </div>
      <div id="footer-details" class="col s12 center">
        <a href="#" class="black-text">
          <i class="fab fa-facebook fa-2x"></i>
        </a>
        <a href="#" class="black-text">
          <i class="fab fa-twitter fa-2x"></i>
        </a>
        <a href="#" class="black-text">
          <i class="fab fa-linkedin fa-2x"></i>
        </a>
        <a href="#" class="black-text">
          <i class="fab fa-instagram fa-2x"></i>
        </a>
      </div>
      <p class="flow-text black-text center" id="c-year"></p>
      <script type="text/javascript">
        var d = new Date();
        document.getElementById("c-year").innerHTML= 'While using this site, you agree to have read and accepted our terms of use, cookie and privacy policy. Copyright '+ d.getFullYear();
      </script>
    </div>
  </div>
</section>

</footer>
{% endblock%}
